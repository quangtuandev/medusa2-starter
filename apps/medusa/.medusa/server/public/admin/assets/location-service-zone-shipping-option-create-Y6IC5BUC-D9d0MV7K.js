import{b as Z,u as te,S as ae,C as ce,a as Q}from"./chunk-ZECHOALZ-CVE-q19L.js";import{C as V,S as le}from"./chunk-PYIO3TDQ-D8Zv8hXV.js";import{f as pe}from"./chunk-IR5DHEKS-aVJcUHa1.js";import{u as A}from"./chunk-HFB3OQXI-9EHt5v8y.js";import{C as B}from"./chunk-OFN7DIZA-BsYHPb_w.js";import{D as de}from"./chunk-NKVMOKZA-CkmXYeKW.js";import{S as ue}from"./chunk-PRLQLEEQ-ChGmVbv0.js";import{c as M}from"./chunk-6GU6IDUA-CDc7wW5L.js";import{K as he}from"./chunk-6HTZNHPT-v1633Mo6.js";import{R as w,u as ee,a as me,S as ge}from"./chunk-AERWK3TJ-37hbpczJ.js";import{ad as fe,aq as xe,dA as _e,aW as U,j as e,r as S,b as se,z as ie,az as je,aA as ye,at as J,F as ne,fM as be,t as X,B as H,aD as z,av as _,s as G,H as Ce,a3 as ve,J as n,K as Se,as as F,I as Oe,v as Pe,x as we,y as Le,au as Ee,eH as ke,aE as Y}from"./index-CZF8bOcC.js";import{b as Te}from"./chunk-GRT22PE5-yYqqrdff.js";import{P}from"./progress-tabs-w6V4gXQI.js";import{R as W}from"./radio-group-CuRQ-SfM.js";import"./chunk-X6BAAGCL-Cmzs-01s.js";import"./chunk-DK4WIVY6-CYCbBMOO.js";import"./Trans-DQQCBdFx.js";import"./index-CBVNHZ-g.js";var Fe=({form:a,isReturn:f=!1,zone:j,locationId:C,fulfillmentProviderOptions:d,selectedProviderId:x,type:y})=>{const{t:r}=se(),u=ie(),h=y==="pickup",p=A({queryFn:s=>G.admin.shippingProfile.list(s),queryKey:["shipping_profiles"],getOptions:s=>s.shipping_profiles.map(i=>({label:i.name,value:i.id}))}),t=A({queryFn:s=>G.admin.shippingOptionType.list(s),queryKey:["shipping_option_types"],getOptions:s=>s.shipping_option_types.map(i=>({label:i.label,value:i.id}))}),m=A({queryFn:s=>G.admin.fulfillmentProvider.list({...s,stock_location_id:C}),queryKey:["fulfillment_providers"],getOptions:s=>s.fulfillment_providers.map(i=>({label:pe(i.id),value:i.id}))});return e.jsx("div",{className:"flex flex-1 flex-col items-center overflow-y-auto",children:e.jsxs("div",{className:"flex w-full max-w-[720px] flex-col gap-y-8 px-6 py-16",children:[e.jsxs("div",{children:[e.jsx(Ce,{children:r(`stockLocations.shippingOptions.create.${h?"pickup":f?"returns":"shipping"}.header`,{zone:j.name})}),e.jsx(ve,{size:"small",className:"text-ui-fg-subtle",children:r(`stockLocations.shippingOptions.create.${f?"returns":h?"pickup":"shipping"}.hint`)})]}),!h&&e.jsx(n.Field,{control:a.control,name:"price_type",render:({field:s})=>e.jsxs(n.Item,{children:[e.jsx(n.Label,{children:r("stockLocations.shippingOptions.fields.priceType.label")}),e.jsx(n.Control,{children:e.jsxs(W,{dir:u,className:"grid grid-cols-1 gap-4 md:grid-cols-2",...s,onValueChange:s.onChange,children:[e.jsx(W.ChoiceBox,{className:"flex-1",value:"flat",label:r("stockLocations.shippingOptions.fields.priceType.options.fixed.label"),description:r("stockLocations.shippingOptions.fields.priceType.options.fixed.hint")}),e.jsx(W.ChoiceBox,{className:"flex-1",value:"calculated",label:r("stockLocations.shippingOptions.fields.priceType.options.calculated.label"),description:r("stockLocations.shippingOptions.fields.priceType.options.calculated.hint")})]})}),e.jsx(n.ErrorMessage,{})]})}),e.jsxs("div",{className:"grid grid-cols-1 gap-4 md:grid-cols-2",children:[e.jsx(n.Field,{control:a.control,name:"name",render:({field:s})=>e.jsxs(n.Item,{children:[e.jsx(n.Label,{children:r("fields.name")}),e.jsx(n.Control,{children:e.jsx(Se,{...s})}),e.jsx(n.ErrorMessage,{})]})}),e.jsx(n.Field,{control:a.control,name:"shipping_profile_id",render:({field:s})=>e.jsxs(n.Item,{children:[e.jsx(n.Label,{children:r("stockLocations.shippingOptions.fields.profile")}),e.jsx(n.Control,{children:e.jsx(B,{...s,options:p.options,searchValue:p.searchValue,onSearchValueChange:p.onSearchValueChange,disabled:p.disabled})}),e.jsx(n.ErrorMessage,{})]})}),e.jsx(n.Field,{control:a.control,name:"shipping_option_type_id",render:({field:s})=>e.jsxs(n.Item,{children:[e.jsx(n.Label,{children:r("stockLocations.shippingOptions.fields.type")}),e.jsx(n.Control,{children:e.jsx(B,{...s,options:t.options,searchValue:t.searchValue,onSearchValueChange:t.onSearchValueChange,disabled:t.disabled})}),e.jsx(n.ErrorMessage,{})]})})]}),e.jsxs("div",{className:"grid grid-cols-1 gap-4 md:grid-cols-2",children:[e.jsx(n.Field,{control:a.control,name:"provider_id",render:({field:s})=>e.jsxs(n.Item,{children:[e.jsx(n.Label,{tooltip:r("stockLocations.fulfillmentProviders.shippingOptionsTooltip"),children:r("stockLocations.shippingOptions.fields.provider")}),e.jsx(n.Control,{children:e.jsx(B,{...s,onChange:i=>{s.onChange(i),a.setValue("fulfillment_option_id","")},options:m.options,searchValue:m.searchValue,onSearchValueChange:m.onSearchValueChange,disabled:m.disabled})}),e.jsx(n.ErrorMessage,{})]})}),e.jsx(n.Field,{control:a.control,name:"fulfillment_option_id",render:({field:s})=>e.jsxs(n.Item,{children:[e.jsx(n.Label,{children:r("stockLocations.shippingOptions.fields.fulfillmentOption")}),e.jsx(n.Control,{children:S.createElement(F,{dir:u,...s,onValueChange:s.onChange,disabled:!x,key:x},e.jsx(F.Trigger,{ref:s.ref,children:e.jsx(F.Value,{})}),e.jsx(F.Content,{children:d==null?void 0:d.filter(i=>!!i.is_return===f).map(i=>e.jsx(F.Item,{value:i.id,children:i.name||i.id},i.id))}))}),e.jsx(n.ErrorMessage,{})]})})]}),e.jsx(Oe,{}),e.jsx(ue,{control:a.control,name:"enabled_in_store",label:r("stockLocations.shippingOptions.fields.enableInStore.label"),description:r("stockLocations.shippingOptions.fields.enableInStore.hint")})]})})},Ne=({form:a,type:f})=>{const j=f==="pickup",{getIsOpen:C,setIsOpen:d}=me(),[x,y]=S.useState(null),r=c=>{d(V,!0),y(c)},u=()=>{d(V,!1),y(null)},{store:h,isLoading:p,isError:t,error:m}=Pe(),s=S.useMemo(()=>{var c;return((c=h==null?void 0:h.supported_currencies)==null?void 0:c.map(b=>b.currency_code))||[]},[h]),{regions:i,isLoading:K,isError:N,error:I}=we({fields:"id,name,currency_code",limit:999}),{price_preferences:L}=Le({}),{setCloseOnEscape:R}=ee(),$=ne({control:a.control,name:"name"}),D=te({name:$,currencies:s,regions:i,pricePreferences:L}),O=p||!h||K||!i,o=S.useMemo(()=>[[...s||[],...i||[]]],[s,i]);if(S.useEffect(()=>{!O&&j&&(s.length>0&&s.forEach(c=>{a.setValue(`currency_prices.${c}`,"0")}),i.length>0&&i.forEach(c=>{a.setValue(`region_prices.${c.id}`,"0")}))},[O,j]),t)throw m;if(N)throw I;return e.jsx(ge,{id:V,onOpenChangeCallback:c=>{c||y(null)},children:e.jsx(ae,{onOpenConditionalPricesModal:r,onCloseConditionalPricesModal:u,children:e.jsxs("div",{className:"flex size-full flex-col divide-y overflow-hidden",children:[e.jsx(de,{isLoading:O,data:o,columns:D,state:a,onEditingChange:c=>R(!c),disableInteractions:C(V)}),x&&e.jsx(ce,{info:x,variant:"create"})]})})})},oe=J({name:_().min(1),price_type:ke(le),enabled_in_store:Ee(),shipping_profile_id:_().min(1),provider_id:_().min(1),fulfillment_option_id:_().min(1),shipping_option_type_id:_().min(1)}),Ie=J({conditional_region_prices:z(_(),Y(Q).optional()),conditional_currency_prices:z(_(),Y(Q).optional())}),De=J({region_prices:z(_(),_().optional()),currency_prices:z(_(),_().optional())}).merge(oe).merge(Ie);function Ve({zone:a,isReturn:f,locationId:j,type:C}){var D,O;const[d,x]=S.useState("details"),[y,r]=S.useState(!1),{t:u}=se(),{handleSuccess:h}=ee(),p=ie(),t=je({defaultValues:{name:"",price_type:"flat",enabled_in_store:!0,shipping_profile_id:"",provider_id:"",fulfillment_option_id:"",region_prices:{},currency_prices:{},conditional_region_prices:{},conditional_currency_prices:{}},resolver:ye(De)}),m=ne({control:t.control,name:"provider_id"}),{fulfillment_options:s}=be(m,{enabled:!!m}),i=t.watch("price_type")==="calculated",{mutateAsync:K,isPending:N}=Te(),I=t.handleSubmit(async o=>{const c=Object.entries(o.currency_prices).map(([l,g])=>{if(g)return{currency_code:l,amount:M(g)}}).filter(l=>!!l),b=Object.entries(o.region_prices).map(([l,g])=>{if(g)return{region_id:l,amount:M(g)}}).filter(l=>!!l),E=Object.entries(o.conditional_region_prices).flatMap(([l,g])=>{const v=(g==null?void 0:g.map(T=>({region_id:l,amount:M(T.amount),rules:Z(T)})))||[];return v==null?void 0:v.filter(Boolean)}),k=Object.entries(o.conditional_currency_prices).flatMap(([l,g])=>{const v=(g==null?void 0:g.map(T=>({currency_code:l,amount:M(T.amount),rules:Z(T)})))||[];return v==null?void 0:v.filter(Boolean)}),q=[...c,...k,...b,...E],re=s==null?void 0:s.find(l=>l.id===o.fulfillment_option_id);await K({name:o.name,price_type:o.price_type,service_zone_id:a.id,shipping_profile_id:o.shipping_profile_id,provider_id:o.provider_id,prices:q,data:re,rules:[{value:f?"true":"false",attribute:"is_return",operator:"eq"},{value:o.enabled_in_store?"true":"false",attribute:"enabled_in_store",operator:"eq"}],type_id:o.shipping_option_type_id},{onSuccess:({shipping_option:l})=>{X.success(u(`stockLocations.shippingOptions.create.${f?"returns":"shipping"}.successToast`,{name:l.name})),h(`/settings/locations/${j}`)},onError:l=>{X.error(l.message)}})}),L=o=>{if(o==="pricing"){t.clearErrors();const c=oe.safeParse({...t.getValues()});if(!c.success){const[b,...E]=c.error.errors;for(const k of E){const q=k.path.join(".");t.setError(q,{message:k.message,type:k.code})}t.setError(b.path.join("."),{message:b.message,type:b.code},{shouldFocus:!0}),r(!1);return}r(!0)}x(o)},R=(D=t.getFieldState("currency_prices"))!=null&&D.isDirty||(O=t.getFieldState("region_prices"))!=null&&O.isDirty||d==="pricing"?"in-progress":"not-started",$=y?"completed":"in-progress";return e.jsx(w.Form,{form:t,children:e.jsx(he,{className:"flex h-full flex-col",onSubmit:I,onKeyDown:o=>{const c=o.key==="Enter",b=o.metaKey||o.ctrlKey,E=d!=="pricing"&&!i;if(c&&(o.preventDefault(),!!b)){if(E){o.stopPropagation(),L("pricing");return}I()}},children:e.jsxs(P,{dir:p,value:d,className:"flex h-full flex-col overflow-hidden",onValueChange:o=>L(o),children:[e.jsx(w.Header,{children:e.jsxs(P.List,{className:"border-ui-border-base -my-2 ml-2 min-w-0 flex-1 border-l",children:[e.jsx(P.Trigger,{value:"details",status:$,className:"w-full max-w-[200px]",children:e.jsx("span",{className:"w-full cursor-auto overflow-hidden text-ellipsis whitespace-nowrap",children:u("stockLocations.shippingOptions.create.tabs.details")})}),!i&&e.jsx(P.Trigger,{value:"pricing",status:R,className:"w-full max-w-[200px]",children:e.jsx("span",{className:"w-full overflow-hidden text-ellipsis whitespace-nowrap",children:u("stockLocations.shippingOptions.create.tabs.prices")})})]})}),e.jsxs(w.Body,{className:"size-full overflow-hidden",children:[e.jsx(P.Content,{value:"details",className:"size-full overflow-y-auto",children:e.jsx(Fe,{form:t,zone:a,isReturn:f,type:C,locationId:j,fulfillmentProviderOptions:s||[],selectedProviderId:m})}),e.jsx(P.Content,{value:"pricing",className:"size-full",children:e.jsx(Ne,{form:t,type:C})})]}),e.jsx(w.Footer,{children:e.jsxs("div",{className:"flex items-center justify-end gap-x-2",children:[e.jsx(w.Close,{asChild:!0,children:e.jsx(H,{variant:"secondary",size:"small",children:u("actions.cancel")})}),d==="pricing"||i?e.jsx(H,{size:"small",className:"whitespace-nowrap",isLoading:N,type:"submit",children:u("actions.save")},"submit-btn"):e.jsx(H,{size:"small",className:"whitespace-nowrap",isLoading:N,onClick:()=>L("pricing"),type:"button",children:u("actions.continue")},"continue-btn")]})})]})})})}var Me="*fulfillment_sets,*fulfillment_sets.service_zones,*fulfillment_sets.service_zones.shipping_options";function is(){var m,s;const{location_id:a,fset_id:f,zone_id:j}=fe(),[C]=xe(),d=C.has("is_return"),{stock_location:x,isPending:y,isFetching:r,isError:u,error:h}=_e(a,{fields:Me}),p=(m=x==null?void 0:x.fulfillment_sets)==null?void 0:m.find(i=>i.id===f);if(!y&&!r&&!p)throw U({message:`Fulfillment set with ID ${f} was not found`},404);const t=(s=p==null?void 0:p.service_zones)==null?void 0:s.find(i=>i.id===j);if(!y&&!r&&!t)throw U({message:`Service zone with ID ${j} was not found`},404);if(u)throw h;return e.jsx(w,{prev:`/settings/locations/${a}`,children:t&&e.jsx(Ve,{zone:t,isReturn:d,locationId:a,type:p.type})})}export{is as Component};
