import{u as G}from"./chunk-YIZSVS2R-q0xf5XcE.js";import{C as J}from"./chunk-GZBFGV7Y-CXE6t3FD.js";import{b as Q,dA as U,x as Y,v as S,dB as Z,r as P,j as e,H as O,K as T,w as d,E as R,X as ee,a3 as se,B as L,h as ae,s as re,I as H}from"./index-D2KVo1a8.js";import{S as h}from"./select-nSD3_BIn.js";var A=i=>(i||[]).map(s=>{var u,p;return{id:s.id,required:s.required,field_type:s.field_type,disguised:s.disguised,attribute:s.attribute,operator:s.operator,values:s.field_type==="number"||s.operator==="eq"?typeof s.values=="object"?(u=s.values[0])==null?void 0:u.value:s.values:(p=s==null?void 0:s.values)==null?void 0:p.map(b=>b.value)}}),le=(i,s)=>{var u;return!i||!s?{}:i==="currency_code"?{value:(u=s.supported_currencies)==null?void 0:u.map(p=>p.currency_code)}:{}},te=({form:i,identifier:s,scope:u,name:p,operator:b,fieldRule:r,attributes:m,ruleType:$})=>{const a=m==null?void 0:m.find(o=>o.value===r.attribute),{store:n,isLoading:E}=ae(),F=G({queryFn:async o=>await re.admin.promotion.listRuleValues($,a==null?void 0:a.id,{...o,...le(a==null?void 0:a.id,n)}),enabled:!!(a!=null&&a.id)&&["select","multiselect"].includes(a.field_type)&&!E,getOptions:o=>o.values,queryKey:["rule-value-options",$,a==null?void 0:a.id]}),C=S({control:i.control,name:b});return e.jsx(d.Field,{name:p,render:({field:{onChange:o,ref:g,...v}})=>(a==null?void 0:a.field_type)==="number"?e.jsxs(d.Item,{className:"basis-1/2",children:[e.jsx(d.Control,{children:e.jsx(H,{...v,type:"number",onChange:o,className:"bg-ui-bg-base",ref:g,min:1,disabled:!r.attribute})}),e.jsx(d.ErrorMessage,{})]}):(a==null?void 0:a.field_type)==="text"?e.jsxs(d.Item,{className:"basis-1/2",children:[e.jsx(d.Control,{children:e.jsx(H,{...v,ref:g,onChange:o,className:"bg-ui-bg-base",disabled:!r.attribute})}),e.jsx(d.ErrorMessage,{})]}):e.jsxs(d.Item,{className:"basis-1/2",children:[e.jsx(d.Control,{children:e.jsx(J,{...v,...F,multiple:C!=="eq",ref:g,placeholder:C==="eq"?"Select Value":"Select Values",onChange:o})}),e.jsx(d.ErrorMessage,{})]})},`${s}.${u}.${p}-${r.attribute}`)},K={id:"product",attribute:"items.product.id",attribute_label:"Product",operator:"eq",operator_label:"Equal",values:[],required:!0,field_type:"select",disguised:!1},ue=({form:i,ruleType:s,setRulesToRemove:u,rulesToRemove:p,scope:b="rules",promotion:r})=>{var z;const{t:m}=Q(),$=i.getValues(),{attributes:a}=U(s,$.type),{fields:n,append:E,remove:F,update:C,replace:o}=Y({control:i.control,name:b,keyName:b}),g=S({control:i.control,name:"type",defaultValue:r==null?void 0:r.type}),v=S({control:i.control,name:"application_method.type",defaultValue:(z=r==null?void 0:r.application_method)==null?void 0:z.type}),X=g?{promotion_type:g,application_method_type:v}:{},{rules:f,isLoading:D}=Z((r==null?void 0:r.id)||null,s,X,{enabled:!!(r!=null&&r.id)||!!g&&!!v});return P.useEffect(()=>{if(!D){if(s==="rules"&&!n.length&&(i.resetField("rules"),o(A(f))),s==="buy-rules"&&!n.length){i.resetField("application_method.buy_rules");const t=r!=null&&r.id||g==="standard"?f:[...f,K];o(A(t))}if(s==="target-rules"&&!n.length){i.resetField("application_method.target_rules");const t=r!=null&&r.id||g==="standard"?f:[...f,K];o(A(t))}}},[g,D,s,n.length,i,o,f,r==null?void 0:r.id]),e.jsxs("div",{className:"flex flex-col",children:[e.jsx(O,{level:"h2",className:"mb-2",children:m(`promotions.fields.conditions.${s}.title`)}),e.jsx(T,{className:"text-ui-fg-subtle txt-small mb-6",children:m(`promotions.fields.conditions.${s}.description`)}),n.map((t,x)=>{const y=t.id;return e.jsxs(P.Fragment,{children:[e.jsxs("div",{className:"bg-ui-bg-subtle border-ui-border-base flex flex-row gap-2 rounded-xl border px-2 py-2",children:[e.jsxs("div",{className:"grow",children:[e.jsx(d.Field,{name:`${b}.${x}.attribute`,render:({field:N})=>{var q;const{onChange:I,ref:w,...V}=N,_=(n==null?void 0:n.map(l=>l.attribute))||[],c=(a==null?void 0:a.filter(l=>l.value===t.attribute?!0:!_.includes(l.value)))||[],M=!!t.required,k=l=>{const j=c.find(W=>W.id===l);C(x,{...t,values:[],disguised:(j==null?void 0:j.disguised)||!1}),I(l)};return e.jsxs(d.Item,{className:"mb-2",children:[t.required&&e.jsx("div",{className:"flex items-center px-2",children:e.jsx("p",{className:"text text-ui-fg-muted txt-small",children:m("promotions.form.required")})}),e.jsx(d.Control,{children:M?e.jsx(B,{label:((q=c==null?void 0:c.find(l=>l.value===t.attribute))==null?void 0:q.label)||"",field:N}):e.jsxs(h,{...V,onValueChange:k,disabled:t.required,children:[e.jsx(h.Trigger,{ref:w,className:"bg-ui-bg-base",children:e.jsx(h.Value,{placeholder:m("promotions.form.selectAttribute")})}),e.jsx(h.Content,{children:c==null?void 0:c.map((l,j)=>e.jsx(h.Item,{value:l.value,children:e.jsx("span",{className:"text-ui-fg-subtle",children:l.label})},`${y}-attribute-option-${j}`))})]})}),e.jsx(d.ErrorMessage,{})]})}}),e.jsxs("div",{className:"flex gap-2",children:[e.jsx(d.Field,{name:`${b}.${x}.operator`,render:({field:N})=>{var k,q;const{onChange:I,ref:w,...V}=N,_=a==null?void 0:a.find(l=>l.value===t.attribute),c=((k=_==null?void 0:_.operators)==null?void 0:k.map((l,j)=>({label:l.label,value:l.value,key:`${y}-operator-option-${j}`})))||[],M=!!t.attribute&&(c==null?void 0:c.length)<=1;return e.jsxs(d.Item,{className:"basis-1/2",children:[e.jsx(d.Control,{children:M?e.jsx(B,{label:((q=c.find(l=>l.value===V.value))==null?void 0:q.label)||"",field:N}):e.jsxs(h,{...V,disabled:!t.attribute,onValueChange:I,children:[e.jsx(h.Trigger,{ref:w,className:"bg-ui-bg-base",children:e.jsx(h.Value,{placeholder:"Select Operator"})}),e.jsx(h.Content,{children:c==null?void 0:c.map(l=>e.jsx(h.Item,{value:l.value,children:e.jsx("span",{className:"text-ui-fg-subtle",children:l.label})},l.key))})]})}),e.jsx(d.ErrorMessage,{})]})}}),e.jsx(te,{form:i,identifier:y,scope:b,name:`${b}.${x}.values`,operator:`${b}.${x}.operator`,fieldRule:t,attributes:a,ruleType:s})]})]}),e.jsx("div",{className:"size-7 flex-none self-center",children:!t.required&&e.jsx(R,{size:"small",variant:"transparent",className:"text-ui-fg-muted",type:"button",onClick:()=>{t.required||(u&&u([...p,t]),F(x))},children:e.jsx(ee,{})})})]}),x<n.length-1&&e.jsxs("div",{className:"relative px-6 py-3",children:[e.jsx("div",{className:"border-ui-border-strong absolute bottom-0 left-[40px] top-0 z-[-1] w-px bg-[linear-gradient(var(--border-strong)_33%,rgba(255,255,255,0)_0%)] bg-[length:1px_3px] bg-repeat-y"}),e.jsx(se,{size:"2xsmall",className:" text-xs",children:m("promotions.form.and")})]})]},`${t.id}.${x}.${t.attribute}`)}),e.jsxs("div",{className:n.length?"mt-6":"",children:[e.jsx(L,{type:"button",variant:"secondary",className:"inline-block",onClick:()=>{E({attribute:"",operator:"",values:[],required:!1})},children:m("promotions.fields.addCondition")}),!!n.length&&e.jsx(L,{type:"button",variant:"transparent",className:"text-ui-fg-muted hover:text-ui-fg-subtle ml-2 inline-block",onClick:()=>{const t=n.map((x,y)=>x.required?null:y).filter(x=>x!==null);u&&u(n.filter(x=>!x.required)),F(t)},children:m("promotions.fields.clearAll")})]})]})},B=P.forwardRef(({label:i,field:s},u)=>e.jsxs("div",{children:[e.jsx("div",{className:"txt-compact-small bg-ui-bg-component shadow-borders-base text-ui-fg-base h-8 rounded-md px-2 py-1.5",children:i}),e.jsx("input",{...s,ref:u,disabled:!0,hidden:!0})]}));B.displayName="DisabledField";export{ue as R};
