import{E as $,U as J}from"./chunk-3JJBLFYN-BRrBeK1I.js";import"./chunk-ZQRKUG6J-DcWZdAhB.js";import{b as M,ac as Z,ab as ee,j as e,ap as se,r as j,ay as te,az as ae,M as ie,N as re,Q as G,R as ne,S as le,af as W,s as oe,t as K,B as I,L as R,U as de,V as ce,W as ue,ah as N,c as he,h as me,_ as D,T as fe,aQ as xe,a5 as pe,X as z,ag as H,a1 as q,a2 as O,aR as ge,aN as be}from"./index-DZUwpLH1.js";import{K as je}from"./chunk-6HTZNHPT-DhHk_kZ7.js";import{R as v,u as ve}from"./chunk-AERWK3TJ-CHqJbyLZ.js";import{s as ye,S as we,r as Ne,a as Te,u as Ce}from"./sortable.esm-BR4mEP6V.js";import{T as B}from"./thumbnail-badge-CF1beUJW.js";import"./chunk-TYTNUPXB-C1FS9XtB.js";import"./chunk-6GU6IDUA-CDc7wW5L.js";var Se=({product:s})=>{const[t,i]=j.useState({}),{t:a}=M(),{handleSuccess:o}=ve(),m=te({defaultValues:{media:ke(s.images,s.thumbnail)},resolver:ae($)}),{fields:l,append:r,remove:d,update:g}=ie({name:"media",control:m.control,keyName:"field_id"}),[h,p]=j.useState(null),C=re(G(le),G(ne,{coordinateGetter:ye})),w=n=>{p(n.active.id)},P=n=>{p(null);const{active:x,over:u}=n;if(x.id!==(u==null?void 0:u.id)){const b=l.findIndex(T=>T.field_id===x.id),V=l.findIndex(T=>T.field_id===(u==null?void 0:u.id));m.setValue("media",Te(l,b,V),{shouldDirty:!0,shouldTouch:!0})}},c=()=>{p(null)},{mutateAsync:S,isPending:_}=W(s.id),E=m.handleSubmit(async({media:n})=>{var T;const x=n.map((f,k)=>({file:f.file,index:k})).filter(f=>!!f.file);let u=[];if(x.length){const{files:f}=await oe.admin.upload.create({files:x.map(k=>k.file)}).catch(()=>(m.setError("media",{type:"invalid_file",message:a("products.media.failedToUpload")}),{files:[]}));u=f}const b=n.map((f,k)=>{var U;const F=x.findIndex(Y=>Y.index===k);return F>-1?{...f,url:(U=u[F])==null?void 0:U.url}:f}),V=(T=b.find(f=>f.isThumbnail))==null?void 0:T.url;await S({images:b.map(f=>({url:f.url,id:f.id})),thumbnail:V||null},{onSuccess:()=>{K.success(a("products.media.successToast")),o()},onError:f=>{K.error(f.message)}})}),y=j.useCallback(n=>x=>{if(x)i(u=>({...u,[n]:!0}));else{const{[n]:u,...b}=t;i(b)}},[t]),Q=()=>{const x=Object.keys(t).map(u=>l.findIndex(b=>b.id===u));d(x),i({})},X=()=>{const n=Object.keys(t);if(!n.length)return;const x=l.findIndex(b=>b.isThumbnail);x>-1&&g(x,{...l[x],isThumbnail:!1});const u=l.findIndex(b=>b.id===n[0]);g(u,{...l[u],isThumbnail:!0}),i({})},L=Object.keys(t).length;return e.jsx(v.Form,{blockSearchParams:!0,form:m,children:e.jsxs(je,{className:"flex size-full flex-col overflow-hidden",onSubmit:E,children:[e.jsx(v.Header,{children:e.jsx("div",{className:"flex items-center justify-end gap-x-2",children:e.jsx(I,{variant:"secondary",size:"small",asChild:!0,children:e.jsx(R,{to:{pathname:".",search:void 0},children:a("products.media.galleryLabel")})})})}),e.jsx(v.Body,{className:"flex flex-col overflow-hidden",children:e.jsxs("div",{className:"flex size-full flex-col-reverse lg:grid lg:grid-cols-[1fr_560px]",children:[e.jsx(de,{sensors:C,onDragEnd:P,onDragStart:w,onDragCancel:c,children:e.jsx("div",{className:"bg-ui-bg-subtle size-full overflow-auto",children:e.jsxs("div",{className:"grid h-fit auto-rows-auto grid-cols-4 gap-6 p-6",children:[e.jsx(we,{items:l.map(n=>n.field_id),strategy:Ne,children:l.map(n=>e.jsx(ze,{onCheckedChange:y(n.id),checked:!!t[n.id],media:n},n.field_id))}),e.jsx(ce,{dropAnimation:Ie,children:h?e.jsx(Me,{media:l.find(n=>n.field_id===h),checked:!!t[l.find(n=>n.field_id===h).id]}):null})]})})}),e.jsx("div",{className:"bg-ui-bg-base overflow-auto border-b px-6 py-4 lg:border-b-0 lg:border-l",children:e.jsx(J,{form:m,append:r})})]})}),e.jsx(N,{open:!!L,children:e.jsxs(N.Bar,{children:[e.jsx(N.Value,{children:a("general.countSelected",{count:L})}),e.jsx(N.Seperator,{}),L===1&&e.jsxs(j.Fragment,{children:[e.jsx(N.Command,{action:X,label:a("products.media.makeThumbnail"),shortcut:"t"}),e.jsx(N.Seperator,{})]}),e.jsx(N.Command,{action:Q,label:a("actions.delete"),shortcut:"d"})]})}),e.jsx(v.Footer,{children:e.jsxs("div",{className:"flex items-center justify-end gap-x-2",children:[e.jsx(v.Close,{asChild:!0,children:e.jsx(I,{variant:"secondary",size:"small",children:a("actions.cancel")})}),e.jsx(I,{size:"small",type:"submit",isLoading:_,children:a("actions.save")})]})})]})})},ke=(s,t)=>{const i=(s==null?void 0:s.map(a=>({id:a.id,url:a.url,isThumbnail:a.url===t,file:null})))||[];if(t&&!i.some(a=>a.url===t)){const a=Math.random().toString(36).substring(7);i.unshift({id:a,url:t,isThumbnail:!0,file:null})}return i},Ie={sideEffects:ue({styles:{active:{opacity:"0.4"}}})},ze=({media:s,checked:t,onCheckedChange:i})=>{const{t:a}=M(),o=j.useCallback(w=>{i(w)},[i]),{attributes:m,listeners:l,setNodeRef:r,setActivatorNodeRef:d,transform:g,transition:h,isDragging:p}=Ce({id:s.field_id}),C={opacity:p?.4:void 0,transform:pe.Transform.toString(g),transition:h};return e.jsxs("div",{className:z("shadow-elevation-card-rest hover:shadow-elevation-card-hover focus-visible:shadow-borders-focus bg-ui-bg-subtle-hover group relative aspect-square h-auto max-w-full overflow-hidden rounded-lg outline-none"),style:C,ref:r,children:[s.isThumbnail&&e.jsx("div",{className:"absolute left-2 top-2",children:e.jsx(H,{content:a("products.media.thumbnailTooltip"),children:e.jsx(B,{})})}),e.jsx("div",{className:z("absolute inset-0 cursor-grab touch-none outline-none",{"cursor-grabbing":p}),ref:d,...m,...l}),e.jsx("div",{className:z("transition-fg absolute right-2 top-2 opacity-0",{"group-focus-within:opacity-100 group-hover:opacity-100 group-focus:opacity-100":!p&&!t,"opacity-100":t}),children:e.jsx(q,{onClick:w=>{w.stopPropagation()},checked:t,onCheckedChange:o})}),e.jsx("img",{src:s.url,alt:"",className:"size-full object-cover object-center"})]})},Me=({media:s,checked:t})=>e.jsxs("div",{className:"shadow-elevation-card-rest hover:shadow-elevation-card-hover focus-visible:shadow-borders-focus bg-ui-bg-subtle-hover group relative aspect-square h-auto max-w-full cursor-grabbing overflow-hidden rounded-lg outline-none",children:[s.isThumbnail&&e.jsx("div",{className:"absolute left-2 top-2",children:e.jsx(B,{})}),e.jsx("div",{className:z("transition-fg absolute right-2 top-2 opacity-0",{"opacity-100":t}),children:e.jsx(q,{checked:t})}),e.jsx("img",{src:s.url,alt:"",className:"size-full object-cover object-center"})]}),Pe=({product:s})=>{const{state:t}=he(),[i,a]=j.useState((t==null?void 0:t.curr)||0),{t:o}=M(),m=me(),{mutateAsync:l,isPending:r}=W(s.id),d=_e(s.images,s.thumbnail),g=j.useCallback(()=>{r||a(c=>(c+1)%d.length)},[d,r]),h=j.useCallback(()=>{r||a(c=>(c-1+d.length)%d.length)},[d,r]),p=j.useCallback(c=>{r||a(c)},[r]),C=()=>{if(r)return;const c=document.createElement("a");c.href=d[i].url,c.download="image",c.target="_blank",c.click()},w=async()=>{var E;const c=d[i];if(!await m({title:o("general.areYouSure"),description:c.isThumbnail?o("products.media.deleteWarningWithThumbnail",{count:1}):o("products.media.deleteWarning",{count:1}),confirmText:o("actions.delete"),cancelText:o("actions.cancel")}))return;const _=((E=s.images)==null?void 0:E.filter(y=>y.id!==c.id).map(y=>({id:y.id,url:y.url})))||[];i===d.length-1&&a(y=>y-1),await l({images:_,thumbnail:c.isThumbnail?"":void 0})};j.useEffect(()=>{const c=S=>{S.key==="ArrowRight"?g():S.key==="ArrowLeft"&&h()};return document.addEventListener("keydown",c),()=>{document.removeEventListener("keydown",c)}},[g,h]);const P=!d.length;return e.jsxs("div",{className:"flex size-full flex-col overflow-hidden",children:[e.jsx(v.Header,{children:e.jsxs("div",{className:"flex items-center justify-end gap-x-2",children:[e.jsxs(D,{size:"small",type:"button",onClick:w,disabled:P,children:[e.jsx(fe,{}),e.jsx("span",{className:"sr-only",children:o("products.media.deleteImageLabel")})]}),e.jsxs(D,{size:"small",type:"button",onClick:C,disabled:P,children:[e.jsx(xe,{}),e.jsx("span",{className:"sr-only",children:o("products.media.downloadImageLabel")})]}),e.jsx(I,{variant:"secondary",size:"small",asChild:!0,children:e.jsx(R,{to:{pathname:".",search:"view=edit"},children:o("actions.edit")})})]})}),e.jsxs(v.Body,{className:"flex flex-col overflow-hidden",children:[e.jsx(Ee,{curr:i,media:d}),e.jsx(De,{curr:i,media:d,prev:h,next:g,goTo:p})]})]})},Ee=({media:s,curr:t})=>{const{t:i}=M();return s.length===0?e.jsxs("div",{className:"bg-ui-bg-subtle flex size-full flex-col items-center justify-center gap-y-4 pb-8 pt-6",children:[e.jsxs("div",{className:"flex flex-col items-center",children:[e.jsx(O,{size:"small",leading:"compact",weight:"plus",className:"text-ui-fg-subtle",children:i("products.media.emptyState.header")}),e.jsx(O,{size:"small",className:"text-ui-fg-muted",children:i("products.media.emptyState.description")})]}),e.jsx(I,{size:"small",variant:"secondary",asChild:!0,children:e.jsx(R,{to:"?view=edit",children:i("products.media.emptyState.action")})})]}):e.jsx("div",{className:"bg-ui-bg-subtle relative size-full overflow-hidden",children:e.jsx("div",{className:"flex size-full items-center justify-center p-6",children:e.jsxs("div",{className:"relative inline-block max-h-full max-w-full",children:[s[t].isThumbnail&&e.jsx("div",{className:"absolute left-2 top-2",children:e.jsx(H,{content:i("products.media.thumbnailTooltip"),children:e.jsx(B,{})})}),e.jsx("img",{src:s[t].url,alt:"",className:"object-fit shadow-elevation-card-rest max-h-[calc(100vh-200px)] w-auto rounded-xl object-contain"})]})})})},A=8,De=({media:s,curr:t,prev:i,next:a,goTo:o})=>{if(!s.length)return null;const l=((r,d)=>{if(r.length<=A)return r;const g=Math.floor(A/2),h=(d-g+r.length)%r.length,p=(h+A)%r.length;return p<h?[...r.slice(h),...r.slice(0,p)]:r.slice(h,p)})(s,t);return e.jsxs("div",{className:"flex shrink-0 items-center justify-center gap-x-2 border-t p-3",children:[e.jsx(D,{size:"small",variant:"transparent",className:"text-ui-fg-muted",type:"button",onClick:i,children:e.jsx(ge,{className:"rtl:rotate-180"})}),e.jsx("div",{className:"flex items-center gap-x-2",children:l.map(r=>{const d=r.id===s[t].id,g=s.findIndex(h=>h.id===r.id);return e.jsx("button",{type:"button",onClick:()=>o(g),className:z("transition-fg size-7 overflow-hidden rounded-[4px] outline-none",{"shadow-borders-focus":d}),children:e.jsx("img",{src:r.url,alt:"",className:"size-full object-cover"})},r.id)})}),e.jsx(D,{size:"small",variant:"transparent",className:"text-ui-fg-muted",type:"button",onClick:a,children:e.jsx(be,{className:"rtl:rotate-180"})})]})},_e=(s,t)=>{const i=(s==null?void 0:s.map(a=>({id:a.id,url:a.url,isThumbnail:a.url===t})))||[];return t&&!i.some(a=>a.isThumbnail)&&i.unshift({id:"thumbnail_only",url:t,isThumbnail:!0}),i},Le=j.createContext(null),Ve=s=>s.get("view")==="edit"?"edit":"gallery",Ae=({product:s})=>{const[t,i]=se(),a=Ve(t),o=m=>()=>{i({view:m})};return e.jsx(Le.Provider,{value:{goToGallery:o("gallery"),goToEdit:o("edit")},children:Re(a,s)})},Re=(s,t)=>{switch(s){case"gallery":return e.jsx(Pe,{product:t});case"edit":return e.jsx(Se,{product:t})}},Qe=()=>{const{t:s}=M(),{id:t}=Z(),{product:i,isLoading:a,isError:o,error:m}=ee(t),l=!a&&i;if(o)throw m;return e.jsxs(v,{children:[e.jsx(v.Title,{asChild:!0,children:e.jsx("span",{className:"sr-only",children:s("products.media.label")})}),e.jsx(v.Description,{asChild:!0,children:e.jsx("span",{className:"sr-only",children:s("products.media.editHint")})}),l&&e.jsx(Ae,{product:i})]})};export{Qe as Component};
